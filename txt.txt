[
  {
    "id": "flow1",
    "type": "tab",
    "label": "Door Monitor",
    "disabled": false,
    "info": ""
  },
  {
    "id": "input1",
    "type": "mqtt in",
    "z": "flow1",
    "name": "Current Sensor",
    "topic": "sensor/current",
    "qos": "2",
    "datatype": "auto",
    "broker": "mqttBroker",
    "x": 120,
    "y": 80,
    "wires": [["functionClamp"]]
  },
  {
    "id": "functionClamp",
    "type": "function",
    "z": "flow1",
    "name": "Clamp & Map to %",
    "func": "var current = parseFloat(msg.payload);\nif (isNaN(current)) return null;\n// enforce 4–20 mA\nif (current < 4) current = 4;\nif (current > 20) current = 20;\n// map to 0–100%\nvar percent = (current - 4) / 16 * 100;\nmsg.current = current;\nmsg.percent = percent;\nmsg.payload = percent;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 350,
    "y": 80,
    "wires": [["ui_gauge1", "functionState"]]
  },
  {
    "id": "ui_gauge1",
    "type": "ui_gauge",
    "z": "flow1",
    "name": "Door Position",
    "group": "ui_group1",
    "order": 0,
    "width": 0,
    "height": 0,
    "gtype": "gage",
    "title": "Position",
    "label": "%",
    "format": "{{value | number:1}}",
    "min": 0,
    "max": "100",
    "colors": ["#00b500", "#e6e600", "#ca3838"],
    "seg1": "",
    "seg2": "",
    "x": 600,
    "y": 40,
    "wires": []
  },
  {
    "id": "functionState",
    "type": "function",
    "z": "flow1",
    "name": "Determine State",
    "func": "msg.state = msg.percent >= 50 ? \"OPEN\" : \"CLOSED\";\nmsg.payload = msg.state + \" (\" + msg.percent.toFixed(1) + \"% \" + (msg.state === \"OPEN\" ? \"open\" : \"closed\") + \")\";\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 600,
    "y": 120,
    "wires": [["ui_text1", "rbe1"]]
  },
  {
    "id": "ui_text1",
    "type": "ui_text",
    "z": "flow1",
    "group": "ui_group1",
    "order": 1,
    "width": 0,
    "height": 0,
    "name": "Door State",
    "label": "State",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 840,
    "y": 120,
    "wires": []
  },
  {
    "id": "rbe1",
    "type": "rbe",
    "z": "flow1",
    "name": "On Change",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "property": "state",
    "x": 840,
    "y": 200,
    "wires": [["functionLog"]]
  },
  {
    "id": "functionLog",
    "type": "function",
    "z": "flow1",
    "name": "Log Events",
    "func": "var log = context.get('log') || [];\nvar entry = {\n    ts: new Date().toLocaleString(),\n    message: \"Door \" + (msg.state === \"OPEN\" ? \"opened\" : \"closed\") +\n             \" (\" + (msg.state === \"OPEN\" ? msg.percent.toFixed(1) + \"% open\" :\n                                         (100 - msg.percent).toFixed(1) + \"% closed\") + \")\"\n};\nlog.push(entry);\ncontext.set('log', log);\nmsg.logs = log;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 1050,
    "y": 200,
    "wires": [["ui_template1"]]
  },
  {
    "id": "ui_template1",
    "type": "ui_template",
    "z": "flow1",
    "group": "ui_group2",
    "name": "Event Log",
    "order": 0,
    "width": 0,
    "height": 0,
    "format": "<table style=\"width:100%\">\n  <tr ng-repeat=\"entry in msg.logs.slice().reverse()\">\n    <td>{{entry.ts}}</td>\n    <td>{{entry.message}}</td>\n  </tr>\n</table>",
    "storeOutMessages": false,
    "fwdInMessages": false,
    "resendOnRefresh": true,
    "templateScope": "local",
    "x": 1280,
    "y": 200,
    "wires": []
  },
  {
    "id": "mqttBroker",
    "type": "mqtt-broker",
    "name": "Local Broker",
    "broker": "localhost",
    "port": "1883",
    "clientid": "",
    "usetls": false,
    "compatmode": true,
    "keepalive": "60",
    "cleansession": true,
    "birthTopic": "",
    "birthQos": "0",
    "birthPayload": "",
    "closeTopic": "",
    "closePayload": "",
    "willTopic": "",
    "willQos": "0",
    "willPayload": ""
  },
  {
    "id": "ui_tab1",
    "type": "ui_tab",
    "name": "Door Monitor",
    "icon": "dashboard",
    "order": 1
  },
  {
    "id": "ui_group1",
    "type": "ui_group",
    "name": "Status",
    "tab": "ui_tab1",
    "order": 1,
    "disp": true,
    "width": "6",
    "collapse": false
  },
  {
    "id": "ui_group2",
    "type": "ui_group",
    "name": "Log",
    "tab": "ui_tab1",
    "order": 2,
    "disp": true,
    "width": "6",
    "collapse": false
  }
]
